<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tienda Virtual - Ventas</title>
    <script>
        const URL_VENTAS = "https://ms-ventas-production-0b54.up.railway.app";

        async function listar() {
            console.log("Listando ventas...");
            try {
                const response = await fetch(URL_VENTAS + "/ventas/listar");
                if (!response.ok) throw new Error("Error HTTP: " + response.status);
                const data = await response.json();
                console.log("Ventas recibidas:", data);
                const tabla = document.getElementById("tablaVentas");
                tabla.innerHTML = "";
                if (!Array.isArray(data)) {
                    console.error("La respuesta no es un array:", data);
                    return;
                }
                for (let i = 0; i < data.length; i++) {
                    const v = data[i];
                    tabla.innerHTML += "<tr>" +
                        "<td>" + (v.codigoVenta ?? "") + "</td>" +
                        "<td>" + (v.cedulaCliente ?? "") + "</td>" +
                        "<td>" + (v.cedulaUsuario ?? "") + "</td>" +
                        "<td>" + (v.valorVenta ?? "") + "</td>" +
                        "<td>" + (v.ivaVenta ?? "") + "</td>" +
                        "<td>" + (v.totalVenta ?? "") + "</td>" +
                        "</tr>";
                }
            } catch (error) {
                console.error("Error al listar:", error);
            }
        }

        async function guardar() {
            const venta = {
                codigoVenta: document.getElementById("codigoVenta").value,
                cedulaCliente: document.getElementById("cedulaCliente").value,
                cedulaUsuario: document.getElementById("cedulaUsuario").value,
                valorVenta: document.getElementById("valorVenta").value,
                ivaVenta: document.getElementById("ivaVenta").value,
                totalVenta: document.getElementById("totalVenta").value
            };
            try {
                const response = await fetch(URL_VENTAS + "/ventas/guardar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(venta)
                });
                if (!response.ok) throw new Error("Error al guardar: " + response.status);
                alert("Venta guardada correctamente");
                listar();
            } catch (error) {
                console.error("Error al guardar:", error);
                alert("Error al guardar venta");
            }
        }

        async function eliminar() {
            const id = document.getElementById("idEliminar").value;
            if (!id) { alert("Ingrese el ID"); return; }
            try {
                const response = await fetch(URL_VENTAS + "/ventas/eliminar/" + id, {
                    method: "DELETE"
                });
                if (!response.ok) throw new Error("Error al eliminar");
                alert("Venta eliminada correctamente");
                listar();
            } catch (error) {
                console.error("Error al eliminar:", error);
                alert("Error al eliminar venta");
            }
        }

        window.onload = listar;
    </script>
</head>
<body>
    <h2>Tienda Virtual</h2>
    <nav>
        <a href="index.jsp">Inicio</a> |
        <a href="usuarios.jsp">Usuarios</a> |
        <a href="clientes.jsp">Clientes</a> |
        <a href="proveedores.jsp">Proveedores</a> |
        <a href="productos.jsp">Productos</a> |
        <a href="ventas.jsp">Ventas</a> |
        <a href="reportes.jsp">Reportes</a>
    </nav>
    <hr/>
    <h3>Gestión de Ventas</h3>
    <table border="1">
        <tr>
            <td>Código Venta:</td>
            <td><input type="text" id="codigoVenta"/></td>
            <td>Cédula Cliente:</td>
            <td><input type="text" id="cedulaCliente"/></td>
        </tr>
        <tr>
            <td>Cédula Usuario:</td>
            <td><input type="text" id="cedulaUsuario"/></td>
            <td>Valor Venta:</td>
            <td><input type="text" id="valorVenta"/></td>
        </tr>
        <tr>
            <td>IVA Venta:</td>
            <td><input type="text" id="ivaVenta"/></td>
            <td>Total Venta:</td>
            <td><input type="text" id="totalVenta"/></td>
        </tr>
        <tr>
            <td colspan="4">
                <input type="button" value="Guardar" onclick="guardar()"/>
            </td>
        </tr>
    </table>
    <hr/>
    <h3>Eliminar Venta</h3>
    <table>
        <tr>
            <td>ID MongoDB:</td>
            <td><input type="text" id="idEliminar"/></td>
            <td><input type="button" value="Eliminar" onclick="eliminar()"/></td>
        </tr>
    </table>
    <hr/>
    <h3>Listado de Ventas</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Código</th>
                <th>Cédula Cliente</th>
                <th>Cédula Usuario</th>
                <th>Valor Venta</th>
                <th>IVA</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="tablaVentas"></tbody>
    </table>
</body>
</html>